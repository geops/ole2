<html>
  <head>
    <title>OpenLayers Editor</title>
    <meta charset="utf-8" />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io/en/v6.3.1/css/ol.css"
    />
    <link rel="stylesheet" href="https://unpkg.com/mapbox-gl@1.2.0/dist/mapbox-gl.css">
    <style>
      body { margin: 0; padding: 0; }
      #map { height: 100%; }
    </style>
  </head>
  <body>
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io/en/v6.3.1/build/ol.js"></script>
    <script src="https://unpkg.com/mapbox-gl@1.2.0/dist/mapbox-gl.js"></script>
    <script src="https://unpkg.com/jsts@2.0.6/dist/jsts.min.js"></script>
    <script src="index.js"></script>
    <div id="map"></div>
    <script type="text/javascript">
      var editLayer = new ol.layer.Vector({
        source: new ol.source.Vector({
          wrapX: false
        })
      });
      const PROJECTION = ol.proj.get("EPSG:3857");

      // Code taken from https://openlayers.org/en/latest/examples/mapbox-layer.html
      var mbMap = new mapboxgl.Map({
        style: 'https://maps.geops.io/styles/travic/style.json?key=5cc87b12d7c5370001c1d655e96f1d54c5404bbb8cc4cfcd2ff5111b',
        attributionControl: false,
        boxZoom: false,
        center: ol.proj.toLonLat([873708.375917, 6105425.847789], PROJECTION),
        container: 'map',
        doubleClickZoom: false,
        dragPan: false,
        dragRotate: false,
        interactive: false,
        keyboard: false,
        pitchWithRotate: false,
        scrollZoom: false,
        touchZoomRotate: false,
      });

      var mbLayer = new ol.layer.Layer({
        render: function (frameState) {
          var canvas = mbMap.getCanvas();
          var viewState = frameState.viewState;
          var visible = mbLayer.getVisible();
          canvas.style.display = visible ? 'block' : 'none';

          var opacity = mbLayer.getOpacity();
          canvas.style.opacity = opacity;

          // adjust view parameters in mapbox
          var rotation = viewState.rotation;
          mbMap.jumpTo({
            center: ol.proj.toLonLat(viewState.center),
            zoom: viewState.zoom - 1,
            bearing: (-rotation * 180) / Math.PI,
            animate: false,
          });

          return canvas;
        },
      });

      var map = new ol.Map({
        layers: [
          mbLayer,
          editLayer,
        ],
        target: "map",
        view: new ol.View({
          center: [873708.375917, 6105425.847789],
          zoom: 15
        })
      });

      var editor = new ole.Editor(map);

      var cad = new ole.control.CAD({
        source: editLayer.getSource()
      });

      var draw = new ole.control.Draw({
        source: editLayer.getSource()
      });

      var drawLine = new ole.control.Draw({
        type: "LineString",
        source: editLayer.getSource()
      });

      var rotate = new ole.control.Rotate({
        source: editLayer.getSource()
      });

      var drawPoly = new ole.control.Draw({
        type: "Polygon",
        source: editLayer.getSource()
      });

      var modify = new ole.control.Modify({
        source: editLayer.getSource(),
      });

      var buffer = new ole.control.Buffer({
        source: editLayer.getSource()
      });

      var union = new ole.control.Union({
        source: editLayer.getSource()
      });

      var intersection = new ole.control.Intersection({
        source: editLayer.getSource()
      });

      var difference = new ole.control.Difference({
        source: editLayer.getSource()
      });

      editor.addControls([
        cad,
        draw,
        drawLine,
        drawPoly,
        modify,
        rotate,
        buffer,
        union,
        intersection,
        difference
      ]);

      var ls = new ole.service.LocalStorage();

      editor.addService(ls);
    </script>
  </body>
</html>
